{% extends 'backends/base_template.html' %}
{% block title %}장르 분포도{% endblock %}
{% block content %}
<style>
  .btn-outline-primary {
    color: #2c3e50;
    border-color: #2c3e50;
}

.btn-outline-primary:hover,
.btn-outline-primary:focus {
    background-color: #2c3e50; 
    border-color: #2c3e50;
    color: white;
}

.btn-outline-primary.active,
.btn-outline-primary:active {
    background-color: #2c3e50;
    border-color: #2c3e50;
    color: white;
}

.btn-group {
    margin-top: 30px;
    margin-bottom: 10px;
}

h3.text-center {
    margin-bottom:15px; 
}
</style>

<!-- 버튼 영역 -->
<div class="d-flex justify-content-center mb-4">
  <div class="btn-group" role="group" aria-label="Half Year Navigation">
    <a href="{% url 'backends:genre_distribution' '2023-1' %}" 
       class="btn btn-outline-primary {% if half_year == '2023-1' %}active{% endif %}">2023년 상반기</a>
    <a href="{% url 'backends:genre_distribution' '2023-2' %}" 
       class="btn btn-outline-primary {% if half_year == '2023-2' %}active{% endif %}">2023년 하반기</a>
    <a href="{% url 'backends:genre_distribution' '2024-1' %}" 
       class="btn btn-outline-primary {% if half_year == '2024-1' %}active{% endif %}">2024년 상반기</a>
    <a href="{% url 'backends:genre_distribution' '2024-2' %}" 
       class="btn btn-outline-primary {% if half_year == '2024-2' %}active{% endif %}">2024년 하반기</a>
    <a href="{% url 'backends:genre_distribution' '2025-1' %}" 
       class="btn btn-outline-primary {% if half_year == '2025-1' %}active{% endif %}">2025년 상반기</a>
  </div>
</div>

<!-- 그래프 영역 -->
<div class="container">
  <div class="row">
    <!-- 왼쪽 그래프 -->
    <div class="col-md-6 mb-4">
      <h3 class="text-center">{{ half_year_display }} 장르 분포</h3>
      <canvas id="genreChart" style="width:100%; height:400px;"></canvas>
    </div>

    <!-- 오른쪽 그래프 -->
    <div class="col-md-6 mb-4">
      <h3 class="text-center" id="subgenreTitle">서브장르 분포</h3>
      <canvas id="subgenreChart" style="width:100%; height:400px;"></canvas>
    </div>
  </div>
</div>

<a href="{% url 'backends:index' %}" class="back-card">
    <div class="back-card-body">
        ← 뒤로가기
    </div>
</a>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function getRandomPaletteColors(count) {
    let shuffled = [...palette].sort(() => 0.5 - Math.random());

    // 요청한 개수가 팔레트 길이보다 작으면 그만큼만 자르기
    if (count <= shuffled.length) {
        return shuffled.slice(0, count);
    }

    // 많으면 그냥 팔레트 전체를 섞은 상태로 반환
    return shuffled;
    }

    const palette = [
    '#e74c3c','#ff6f61','#ff9f68','#e67e22','#f39c12',
    '#f1c40f','#ffe156','#d6e680','#a3cb38','#27ae60',
    '#2ecc71','#58d68d','#1abc9c','#16a085','#48c9b0',
    '#82ccdd','#3498db','#2980b9','#5dade2','#9b59b6',
    '#8e44ad','#af7ac5','#d7bde2','#ff6b81','#fab1a0',
    '#fd79a8','#e17055','#e84393','#95a5a6','#bdc3c7'
    ];
    const genreLabels = {{ labels|safe }};
    const genreData = {{ data|safe }};
    const genreIds   = {{ ids|safe }};
    const halfYear   = "{{ half_year }}";
    const genreCtx = document.getElementById('genreChart').getContext('2d');
    const subgenreCtx = document.getElementById('subgenreChart').getContext('2d');

    // 1. 장르 분포 차트
    const genreChart = new Chart(genreCtx, {
        type: 'pie',
        data: {
            labels: genreLabels,
            datasets: [{
                data: genreData,
                backgroundColor: getRandomPaletteColors(genreLabels.length)
            }]
        },
        options: {
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const genreId = genreIds[index];
                    const genreName = genreLabels[index];
                    loadSubgenreChart(genreId, genreName);
                }
            }
        }
    });

    // 2. 서브장르 차트 (빈 상태로 초기화)
    let subgenreChart = new Chart(subgenreCtx, {
        type: 'pie',
        data: { labels: [], datasets: [{ data: [] }] },
        options: { 
            responsive: true,
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const subgenreId = subgenreChart.data.subgenreIds[index];

                    // 해당 서브장르 프로그램 리스트 페이지로 이동
                    window.location.href = `/subgenre/${subgenreId}/${halfYear}/`;
                }
            }
        }
    });

    // 3. 서브장르 데이터를 불러와서 차트 업데이트
    function loadSubgenreChart(genreId, genreName) {
        fetch(`/api/subgenre/${genreId}/${halfYear}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("subgenreTitle").innerText = genreName + "의 서브장르 분포";

                const colors = getRandomPaletteColors(genreLabels.length);

                subgenreChart.data.labels = data.labels;
                subgenreChart.data.datasets[0].data = data.data;
                subgenreChart.data.datasets[0].backgroundColor = colors;
                subgenreChart.data.subgenreIds = data.ids;
                subgenreChart.update();
            });
    }
</script>

{% endblock %}